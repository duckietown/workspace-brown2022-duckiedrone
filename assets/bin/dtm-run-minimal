#!/usr/bin/env bash

source dtm-init

# define user workspaces
DTM_USER_WORKSPACES="brown2022,"
DTM_CONTAINER_NAME="${DTM_SERVICE_NAME}"

# define environment file
DTM_STACK_ENV_FILE="/tmp/${DTM_USER_WS_NAME}__${DTM_STACK_NAME}.env"
cat <<EOT > "${DTM_STACK_ENV_FILE}"
ARCH=${DTM_ARCH}
DTM_USER_WORKSPACES=${DTM_USER_WORKSPACES}
EOT

# start or attach
if [ "${__STACK_ROLE__}" = "start" ]; then
    echo "Running container, this might take a while..."
    # create
    docker-compose \
        --file "${DTM_STACK_FILE}" \
        --project-name "${DTM_USER_WS_NAME}" \
        --env-file "${DTM_STACK_ENV_FILE}" \
        up \
            --no-start
    sleep 0.5
    # start
    docker start -ia "${DTM_CONTAINER_NAME}"
else
    echo "Waiting for container to be brought up..."
    while true; do
        if [ "$(docker ps -aq -f status=running -f name="${DTM_CONTAINER_NAME}")" ]; then
            break
        else
            sleep 4
        fi
    done
    docker exec -it "${DTM_CONTAINER_NAME}" bash
fi
